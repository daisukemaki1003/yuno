---

# エージェント実装依頼：議事録自動生成（Delta30s）とセクション更新差分

## 目的 / スコープ

* **目的**：リアルタイム transcript から 30 秒ごとの議事録スナップショット **Delta30s** を生成し、最新セクション一覧を基に差分応答 **SectionUpdateResponse** を返すバックエンドロジックを実装する。
* **対象**：アプリ内のサーバーサイド（Hono API / services）。エンドポイント or サービス層の公開までを含む。
* **除外**：UI、永続化、通知連携、リアルタイム SSE への再配信（別タスクで扱う）。

---

## ワークフローの約束

1. **既存機能の改修 → 新規機能の実装** の順でタスクを進める。混在は禁止。
2. 各タスクが完了したら必ずアウトプットを共有し、**ユーザ検証（レビュー/動作確認）が終わるまで次のタスクへ進まない**。
3. 検証結果で修正が出た場合は、同じタスク内で対応して再提出する。

---

## 参照資料 / 事前読了

- I/O 仕様書: `services/docs/features/議事録自動生成 IO仕様.md`
- TODO: `services/docs/prompts/TODO：議事録自動生成とセクション生成.md`
- Transcript 取得レイヤー: `services/src/services/ws-relay.service.ts`
- 既存 minutes SSE 方針: `services/docs/prompts/実装依頼ドキュメント：リアルタイム議事録（SSE）.md`

---

## 実装タスク（検証ゲート付き）

### 既存機能の改修
1. **15秒 → 30秒サイクル化**
   - transcript 集約間隔/タイマー・関連定数（`EMIT_INTERVAL_SEC` 等）を 30 秒前提に更新。
   - 影響箇所：minutes SSE、state 管理、テスト。
   - 成果物共有後、ユーザ検証完了まで待機。
2. **設定コメント整合**
   - 30 秒サイクルを前提とした設定ファイル・ドキュメントを更新し、齟齬がないか確認。
   - 検証待ちの間は次タスクへ進まない。

### 新規機能の実装
3. **ドメイン型 / スキーマ定義**
   - `services/src/domain/minutes`（新設想定）に `Delta30s`, `Action`, `Decision`, `Question`, `CurrentSectionList`, `SectionUpdateResponse` の型 + Zod スキーマを追加。
   - ユニットテストを含め、完了後に検証待ち。
4. **30秒設定ファイル雛形**
   - `services/src/config/minutes-final.config.ts`（仮名）を作成し、30 秒窓やしきい値を集約。調整項目には TODO コメントを付与。
   - 検証完了後に次へ。
5. **Delta30s 生成サービス**
   - transcript を 30 秒窓で集計して summaries/actions/decisions/questions を生成するサービスを実装。ノイズ除去、重複統合、LLM/ルール切替、JSON Schema 準拠とリトライ含む。
   - テスト結果を共有し、検証完了まで待機。
6. **Section 差分エンジン**
   - 最新 `Delta30s` と `CurrentSectionList` から `SectionUpdateResponse` を組み立てるロジックを実装（新規/更新/クローズ判定、アクション統合、`change_summary`）。
   - 検証完了後に次タスクへ。
7. **I/O 露出（API / サービス）**
   - Hono ルート or サービス公開関数（例: `POST /v1/meetings/:meetingId/delta30s` / `sections`）を追加し、バリデーション/認証を適用。
   - 動作確認結果を共有し、検証待ち。
8. **テスト & ドキュメント整備**
   - 30 秒窓、差分エンジン、API のユニット/統合テストを追加。`services/docs/`（runbook / testing guide）を更新。
   - 検証承認後にタスク完了。

---

## 入出力サマリ

### Delta30s（出力）
```ts
export type Delta30s = {
  summaries: string[]; // 必須, 1要点=1文, 30秒内の主要トピック
  actions: Action[]; // 必須, 0件可
  decisions?: Decision[];
  questions?: Question[];
};
```
- `actions[*].task` は必須。`owner/due/confidence` は任意。
- due は `YYYY-MM-DD` 形式に正規化。

### SectionUpdateResponse（出力）
```ts
export type SectionUpdateResponse = {
  meeting_id: string;
  changed_sections: Section[]; // 新規/更新/クローズのみ
  change_summary: {
    created_sections: string[];
    updated_sections: string[];
    closed_sections: string[];
  };
};
```
- `changed_sections[*].status` は `provisional | active | closed`。
- `actions` は重複除去済みの一覧を返す。

### CurrentSectionList（入力）
```ts
export type CurrentSectionList = {
  meeting_id: string;
  sections: Section[]; // status = closed は含めない
};
```

---

## 受け入れ条件 / DoD

- 30 秒サイクルへの改修が minutes.partial の配信に影響なく機能し、テストが通る。
- 30 秒以内の transcript バッチを渡すと `Delta30s` を返し、必須フィールドが欠落しない。
- `Delta30s` + `CurrentSectionList` から差分を生成すると、変更のあるセクションのみが `changed_sections` に含まれる。
- `change_summary` の各配列は常に存在（空配列含む）。
- JSON 出力は TypeScript 型および Zod スキーマに適合し、日付・配列長など仕様どおり。
- エラー時は 4xx / 5xx を適切に返し、ログに meetingId / window 情報を含める。

---

## テスト方針

- `services/tests/services/delta30s-builder.test.ts`：ノイズ発話や低 confidence が除外されること、30 秒窓結合が正しいことを検証。
- `services/tests/services/section-diff.test.ts`：セクションの新規/更新/クローズ判定、`change_summary` を確認。
- `services/tests/routes/meetings-delta30s.test.ts`（ルートを作成する場合）：HTTP 422/200 レスポンスを確認。
- LLM 呼び出しが難しい場合、`it.skip` またはスタブクライアントで代替し、実装コードは常に本番 LLM を呼べる構造にする。

---

## 依頼メッセージ（コピペ用）

```
# 実装依頼: 議事録自動生成（Delta30s）& セクション差分

進め方:
- 既存機能の改修（15秒→30秒サイクル化）を完了 → 検証待ち → 承認後に新規機能へ進む手順でお願いします。
- 各タスク完了ごとにアウトプットを共有し、検証が終わるまで次タスクには着手しないでください。

目的:
- transcript から 30 秒ごとに Delta30s(JSON) を生成し、CurrentSectionList を入力に SectionUpdateResponse を返す API/サービスを追加します。

要件:
- 型/スキーマは `services/docs/features/議事録自動生成 IO仕様.md` 通り。TypeScript + Zod で実装。
- transcript を 30 秒窓にバケット化し、ノイズ/重複を除去。LLM で summaries/actions/decisions/questions を生成する場合は JSON Schema 厳守 + 再試行 1 回。
- Section 差分ロジックは Delta30s と現状セクションを突き合わせ、新規/更新/クローズを検出。change_summary は配列 3 種を必ず返す。
- Hono ルート（POST）かサービス公開で I/O を確認できるようにする。認証は既存 minutes SSE と同じで OK。
- ロガーに meetingId・window 情報を含める。エラー時は 4xx/5xx を返却。

提供物:
- 実装コード（services/src/...）+ 型/スキーマ + ルート
- テスト（ユニット + 統合）
- ドキュメント更新（API / テスト手順）

環境変数:
- 追加なし（LLM を使う場合は別途 TODO）

備考:
- 仕様は `services/docs/features/議事録自動生成 IO仕様.md` を参照。タスク分割は `services/docs/prompts/TODO：議事録自動生成とセクション生成.md` を確認してください。
```

---

## メモ

- LLM の採否は後続タスクで調整可。まずはモック/ルールで骨格を作り、後で置き換えられる設計にする。
- Section ID の採番ポリシーや永続化は別タスク。今回のロジックでは入力を信頼し、辞書が無い場合は新規作成時に仮 ID を生成する方針でコメントしておく。

---
